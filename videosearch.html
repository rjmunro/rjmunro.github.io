<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Video Event Binary Search Canvas</title>
<style>
  html, body { margin:0; padding:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; font-family:sans-serif; overflow:hidden; }
  #canvasContainer { flex:1; display:flex; justify-content:center; align-items:center; width:100%; }
  canvas { border:1px solid #ccc; background:#eee; cursor:pointer; }
  #controls { display:none; margin:10px; }
  #controls button { margin:5px; font-size:16px; padding:8px 16px; }
  #saveBtn { margin-top:10px; display:none; }
  #tooltip { position:absolute; padding:4px 6px; background: rgba(0,0,0,0.7); color:#fff; font-size:12px; border-radius:3px; pointer-events:none; display:none; }
</style>
</head>
<body>
<div id="canvasContainer">
<canvas id="canvas"></canvas>
<div id="tooltip"></div>
</div>
<div id="controls">
  <p>Has the event occurred?</p>
  <button id="yesBtn">Yes</button>
  <button id="noBtn">No</button>
  <button id="saveBtn">Save Timestamp</button>
</div>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const controls = document.getElementById('controls');
const yesBtn = document.getElementById('yesBtn');
const noBtn = document.getElementById('noBtn');
const saveBtn = document.getElementById('saveBtn');
const tooltip = document.getElementById('tooltip');

let video = document.createElement('video');
video.crossOrigin = 'anonymous';
video.muted = true;
video.playsInline = true;

let markers = [];
let start = 0, end = 0, current = 0;
let timelineHeight = 50;

let videoAspect = 16/9;

function resizeCanvas(){
    const containerWidth = window.innerWidth;
    const containerHeight = window.innerHeight - controls.offsetHeight;
    const maxWidth = containerWidth * 0.95;
    const maxHeight = containerHeight * 0.95;

    if(maxWidth/maxHeight > videoAspect){
        canvas.height = maxHeight;
        canvas.width = maxHeight * videoAspect;
    } else {
        canvas.width = maxWidth;
        canvas.height = maxWidth / videoAspect;
    }
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function drawTimeline(){
    ctx.fillStyle = '#ccc';
    ctx.fillRect(0, canvas.height - timelineHeight, canvas.width, timelineHeight);
    markers.forEach(m => {
        ctx.fillStyle = m.color;
        const x = m.time/video.duration * canvas.width;
        ctx.fillRect(x-3, canvas.height - timelineHeight, 6, timelineHeight);
    });
}

function drawVideoFrame(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(video.readyState >= 2){
        const videoHeight = canvas.height - timelineHeight;
        const videoWidth = videoHeight * video.videoWidth / video.videoHeight;
        const offsetX = (canvas.width - videoWidth)/2;
        ctx.drawImage(video, offsetX, 0, videoWidth, videoHeight);
    }
    drawTimeline();
    requestAnimationFrame(drawVideoFrame);
}

function addMarker(time, color){
    markers.push({time,color});
}

function binaryStep(answer){
    if(answer==='yes'){
        addMarker(current,'green');
        end=current;
        current = start + (end-start)/2;
    } else {
        addMarker(current,'red');
        start=current;
        current = start + (end-start)/2;
    }
    video.currentTime=current;
    video.play();
    setTimeout(()=>video.pause(),200);
    if(Math.abs(end-start)<0.05){
        alert('Event found at: '+current.toFixed(2)+' seconds');
        saveBtn.style.display='inline';
    }
}

function fileDropSetup(){
    window.addEventListener('dragover', e=>e.preventDefault());
    window.addEventListener('drop', e=>{
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if(file){
            const url = URL.createObjectURL(file);
            video.src = url;
            video.addEventListener('loadedmetadata',()=>{
                videoAspect = video.videoWidth / video.videoHeight;
                resizeCanvas();
                start=0; end=video.duration;
                current=(start+end)/2;
                video.currentTime=current;
                video.pause();
                controls.style.display='block';
            }, {once:true});
        }
    });
}
fileDropSetup();

yesBtn.addEventListener('click',()=>binaryStep('yes'));
noBtn.addEventListener('click',()=>binaryStep('no'));
saveBtn.addEventListener('click',()=>{
    const timestamp=current.toFixed(2);
    const blob=new Blob([timestamp],{type:'text/plain'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='event_timestamp.txt';
    a.click();
});

canvas.addEventListener('mousemove', e=>{
    if(!video.duration) return;
    const rect=canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const hoverTime = x/canvas.width * video.duration;
    tooltip.style.display='block';
    tooltip.style.left = e.clientX+10+'px';
    tooltip.style.top = e.clientY+10+'px';
    tooltip.textContent = hoverTime.toFixed(2)+'s';
});
canvas.addEventListener('mouseleave', ()=>tooltip.style.display='none');

requestAnimationFrame(drawVideoFrame);
</script>
</body>
</html>
