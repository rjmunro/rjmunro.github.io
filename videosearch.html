<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interactive Video Binary Search</title>
<style>
  html, body { margin:0; padding:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; font-family:sans-serif; overflow:hidden; background:#111; }
  #canvasContainer { flex:1; display:flex; justify-content:center; align-items:center; width:100%; }
  canvas { border:1px solid #333; background:#000; cursor:pointer; }
  #controls { display:none; margin:10px; color:white; }
  #controls button { margin:5px; font-size:16px; padding:8px 16px; }
  #saveBtn { margin-top:10px; display:none; }
  #tooltip { position:absolute; padding:4px 6px; background: rgba(0,0,0,0.7); color:#fff; font-size:12px; border-radius:3px; pointer-events:none; display:none; }
</style>
</head>
<body>
<div id="canvasContainer">
<canvas id="canvas"></canvas>
<div id="tooltip"></div>
</div>
<div id="controls">
  <p>Has the event occurred?</p>
  <button id="yesBtn">Yes</button>
  <button id="noBtn">No</button>
  <button id="saveBtn">Save Timestamp</button>
</div>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const controls = document.getElementById('controls');
const yesBtn = document.getElementById('yesBtn');
const noBtn = document.getElementById('noBtn');
const saveBtn = document.getElementById('saveBtn');
const tooltip = document.getElementById('tooltip');

let video = document.createElement('video');
video.crossOrigin = 'anonymous';
video.muted = true;
video.playsInline = true;
video.preload = 'auto';
video.style.display = 'none';

let markers = [];
let start = 0, end = 0, current = 0;
let timelineHeight = 50;
let videoAspect = 16/9;
let readyFrame = false;

function resizeCanvas(){
    const containerWidth = window.innerWidth;
    const containerHeight = window.innerHeight - controls.offsetHeight;
    const maxWidth = containerWidth * 0.95;
    const maxHeight = containerHeight * 0.95;

    if(maxWidth/maxHeight > videoAspect){
        canvas.height = maxHeight;
        canvas.width = maxHeight * videoAspect;
    } else {
        canvas.width = maxWidth;
        canvas.height = maxWidth / videoAspect;
    }
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function drawTimeline(){
    ctx.fillStyle = '#333';
    ctx.fillRect(0, canvas.height - timelineHeight, canvas.width, timelineHeight);

    markers.forEach(m => {
        ctx.fillStyle = m.color;
        const x = m.time/video.duration * canvas.width;
        ctx.fillRect(x-3, canvas.height - timelineHeight, 6, timelineHeight);
    });

    if(video.duration > 0){
        const x = video.currentTime / video.duration * canvas.width;
        const yBottom = canvas.height;
        const yTop = canvas.height - timelineHeight;
        const triangleHeight = timelineHeight / 3;
        ctx.beginPath();
        ctx.moveTo(x, yTop);
        ctx.lineTo(x, yBottom - triangleHeight);
        ctx.strokeStyle = 'yellow';
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(x, yBottom - triangleHeight);
        ctx.lineTo(x - 6, yBottom);
        ctx.lineTo(x + 6, yBottom);
        ctx.closePath();
        ctx.fillStyle = 'yellow';
        ctx.fill();
    }
}

function drawVideoFrame(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(video.readyState >= 2 && readyFrame){
        const videoHeight = canvas.height - timelineHeight;
        const videoWidth = videoHeight * video.videoWidth / video.videoHeight;
        const offsetX = (canvas.width - videoWidth)/2;
        ctx.drawImage(video, offsetX, 0, videoWidth, videoHeight);
    }
    drawTimeline();
    requestAnimationFrame(drawVideoFrame);
}

function addMarker(time, color){
    markers = markers.filter(m => !(Math.abs(m.time - time) < 0.1 && m.color !== color));
    markers.push({time,color});
    markers.sort((a,b)=>a.time-b.time);
}

function getLastMarkers(){
    const yesMarkers = markers.filter(m=>m.color==='green');
    const noMarkers = markers.filter(m=>m.color==='red');
    const lastYes = yesMarkers.length ? yesMarkers[yesMarkers.length-1].time : 0;
    const firstNo = noMarkers.length ? noMarkers[0].time : video.duration;
    return {lastYes, firstNo};
}

function binaryStep(answer){
    // Corrected logic: yes -> green -> go backwards, no -> red -> go forwards
    addMarker(current, answer==='yes' ? 'green' : 'red');

    const {lastYes, firstNo} = getLastMarkers();

    if(answer === 'yes') {
        end = current;
    } else {
        start = current;
    }

    current = start + (end - start) / 2;

    if(Math.abs(end - start) < 0.05){
        alert('Event found at: '+current.toFixed(2)+' seconds');
        saveBtn.style.display='inline';
        return;
    }
    seekTo(current);
}

function handleClick(event){
    if(!video.duration) return;
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const clickTime = x / canvas.width * video.duration;
    current = clickTime;
    seekTo(clickTime);
    const {lastYes, firstNo} = getLastMarkers();
    if(clickTime > lastYes && clickTime < firstNo) {
        video.play();
        setTimeout(()=>video.pause(),200);
    } else {
        const mid = lastYes + (firstNo - lastYes) / 2;
        seekTo(mid);
    }
}

function seekTo(time){
    readyFrame = false;
    video.currentTime = time;
}

video.addEventListener('seeked', ()=>{
    readyFrame = true;
});

function fileDropSetup(){
    window.addEventListener('dragover', e=>e.preventDefault());
    window.addEventListener('drop', e=>{
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if(file){
            const url = URL.createObjectURL(file);
            video.src = url;
            video.addEventListener('loadedmetadata',()=>{
                videoAspect = video.videoWidth / video.videoHeight;
                resizeCanvas();
                start = 0; end = video.duration; current = (start + end) / 2;
                seekTo(current);
                video.pause();
                controls.style.display = 'block';
            }, {once:true});
        }
    });
}

fileDropSetup();

canvas.addEventListener('click', handleClick);
yesBtn.addEventListener('click',()=>binaryStep('yes'));
noBtn.addEventListener('click',()=>binaryStep('no'));
saveBtn.addEventListener('click',()=>{
    const timestamp=current.toFixed(2);
    const blob=new Blob([timestamp],{type:'text/plain'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='event_timestamp.txt';
    a.click();
});

canvas.addEventListener('mousemove', e=>{
    if(!video.duration) return;
    const rect=canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const hoverTime = x/canvas.width * video.duration;
    tooltip.style.display='block';
    tooltip.style.left = e.clientX+10+'px';
    tooltip.style.top = e.clientY+10+'px';
    tooltip.textContent = hoverTime.toFixed(2)+'s';
});
canvas.addEventListener('mouseleave', ()=>tooltip.style.display='none');

requestAnimationFrame(drawVideoFrame);
</script>
</body>
</html>
